#!/usr/bin/env ruby

require 'rest-client'
require 'json'
require 'serialport'
require 'rails'

def message_from(sp)
  if sp.present?
    message = sp.gets
    if message.present?
      message.chomp!
      {message: message}
    end
  end
end


port_str = '/dev/ttyACM1'
baud_rate = 9600
data_bits = 8
stop_bits = 1
parity = SerialPort::NONE
url = 'http://localhost:3000/dashboard/input_biobox'

sp = SerialPort.new(port_str, baud_rate, data_bits, stop_bits, parity)

while(true) do
  message = message_from(sp)
  if message.present?
    documento = RestClient.get(url, message)

    puts 'Guardando ticked.pf'
    file = File.open('tmp/ticked.pdf', 'wb+')

    file << documento

    file.close

    puts 'Imprimiendo El Ticked'

    %x(lp tmp/ticked.pdf)

    #puts %x(ls tmp/ticked.pdf)
    puts 'ImpreciÃ³n finalizada'
  end
end
